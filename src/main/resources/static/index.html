<!doctype html>
<html class="no-js" lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Counterpoint Composer</title>
    <link rel="stylesheet" href="css/foundation.css" />
    <script src="js/vendor/modernizr.js"></script>
    <script src="js/nfclient.js"></script>
  </head>

  <body>
    <!-- First top bar -->
    <nav class="top-bar" data-topbar role="navigation">
      <ul class="title-area">
        <li class="name">
          <h1><a href="#">Counterpoint Composer</a></h1>
        </li>
      </ul>

      <section class="top-bar-section">
        <!-- Right Nav Section -->
        <ul class="right">
          <li><a href="http://pivotal.io/platform/" target="_blank"><img src="img/cloudfoundry-logo.png" ></a></li>
        </ul>
        <ul class="right">
          <li><a href="http://pivotal.io/platform" target="_blank"><i>and Cloud Foundry</i></a></li>
        </ul>
        <ul class="right">
          <li><a href="http://projects.spring.io/spring-boot/" target="_blank"><img src="img/spring-logo.png" ></a></li>
        </ul>
        <ul class="right">
          <li><a href="http://projects.spring.io/spring-boot/" target="_blank"><i>powered by Spring Boot</i></a></li>
        </ul>

      </section>
    </nav>

    <nav class="top-bar" data-topbar role="navigation">
      <section class="top-bar-section">
        <!-- Left Nav Section -->
        <li class="left"><label>&nbsp;</label></li>

        <ul class="left">
          <select name="species" id="speciesIds">
            <option value="1">First species</option>
            <option value="2">Second species</option>
            <option value="3">Third species</option>
            <option value="4">Fourth species</option>
            <option value="5">Fifth species</option>
          </select>
        </ul>

        <li class="left"><label>&nbsp;</label></li>

        <ul class="left">
          <select name="modes" id="modeIds">
            <option value="0">Ionian mode</option>
            <option value="1">Dorian mode</option>
            <option value="2">Phrygian mode</option>
            <option value="3">Lydian mode</option>
            <option value="4">Mixolydian mode</option>
            <option value="5">Aeolian mode</option>
            <option value="6">Locrian mode</option>
          </select>
        </ul>

        <li class="left"><label>&nbsp;</label></li>

        <ul class="left">
          <li><a onclick="readMainMelody()">Compose</a></li>
        </ul>

        <li class="left"><label>&nbsp;</label></li>

        <ul class="left">
          <li><a onclick="initNoteflight()">Clear</a></li>
        </ul>

      </section>
    </nav>

    <div>
      <!--a href="#" data-reveal-id="noCounterpointModal">Click Me For A Modal</a-->
      <div id="noCounterpointModal" class="reveal-modal" data-reveal aria-labelledby="modalTitle" aria-hidden="true" role="dialog">
        <h2 id="modalTitle">I wasn't able to compute the counterpoint.</h2>
        <p class="lead">I think you ought to know I'm feeling very depressed.</p>
        <p>You can blame the Sirius Cybernetics Corporation for making androids with Genious People Personalities.
          Seriously though, please try again, perhaps with a shorter cantus firmus, less complex initial chord, or different species. </p><br/>
          Sincerely, <br/>
          Marvin the Robot</p>
        <a class="close-reveal-modal" aria-label="Close">&#215;</a>
      </div>
      <div id="score1"></div>
        <script>
          var scoreView;
          var widthMargin = 20;   // Margin between Noteflight client and right side of window
          var heightMargin = 100; // Margin between Noteflight client and bottom of window

          initNoteflight();

          function initNoteflight() {
              // Initialize the Noteflight client API.
            NFClient.init(function (info) {
              //alert("Noteflight API is ready, version " + info.version);
            });

            var options = {
              host: 'hacking.sites.noteflight.com',
              width: 900,
              height: 650,
              viewParams: {
                scale: 1.0,
                role: 'template',
                app: 'html5',
                displayMode: 'flow'
              }
            };

            options.width = window.innerWidth - widthMargin;
            options.height = window.innerHeight - heightMargin;

            scoreView = new NFClient.ScoreView('score1', '3b88798c7533d46aa60c3c8077e44742c7c4027a', options);
          }

          function callCounterpointService(mainMelody, initialNotes, scaleModeSelection, speciesSelection) {
            var cantusFirmusJson = {
              "mainMelody" : mainMelody,
              "partsInitialNotes" : initialNotes,
              //"partsInitialNotes" : [48, 67, 72],
              "counterpointSpecies" : speciesSelection,
              "scaleMode" : scaleModeSelection
            };
            cantusFirmusJson = JSON.stringify(cantusFirmusJson);
            $.ajax({
              method: 'POST',
              contentType: 'application/json',
              //url: 'http://localhost:8080/counterpoint',
              url: '/counterpoint',
              data: cantusFirmusJson
            }).done(function (doc) {
              scoreView.loadMusicXML(doc.documentElement.outerHTML);
            }).error(function (err) {
              //alert(err.responseText);
              $('#noCounterpointModal').foundation('reveal', 'open');
            });
          }

          function readMainMelody() {

            scoreView.getScore().done(function(scoreData) {
              var mainMelodyPitches = [];
              var initialPitches = [];
              var initialNoteSet;
              if (scoreData != null && scoreData.staves.length > 0) {
                var curStaff = scoreData.staves[0];
                for (var measIdx = 0; measIdx < curStaff.measures.length; measIdx++) {
                  var curMeasure = curStaff.measures[measIdx];
                  for (var noteSetIdx = 0; noteSetIdx < curMeasure.noteSets.length; noteSetIdx++) {
                    var curNoteSet = curMeasure.noteSets[noteSetIdx];
                    if (curNoteSet.notes.length > 0) {
                      //var curNote = curNoteSet.notes[0];
                      var curNote = curNoteSet.notes[curNoteSet.notes.length - 1];
                      console.log("curNote.pitch:" + (curNote.pitch + 12));
                      mainMelodyPitches.push(curNote.pitch + 12);

                      //If we pushed the second note in the melody line, use it to reserve one of the initial pitches
                      if (mainMelodyPitches.length == 2) {
                        // If there is more than one note in the initial NoteSet of the first measure in the
                        // first staff, then use this NoteSet to get initial pitches
                        if (initialNoteSet.notes.length > 1) {
                          initialPitches = getInitialNotesFromNoteset(initialNoteSet, curNote.pitch);
                        }
                        // otherwise, get the initial pitches from the first note of each staff
                        else {
                          initialPitches = getInitialNotesFromAllStaves(scoreData.staves, curNote.pitch);
                        }
                      }

                      // If this is the first noteSet, save it
                      if (measIdx == 0 && noteSetIdx == 0) {
                        initialNoteSet = curNoteSet;
                      }

                    }
                  }
                }
              }
              /*
               * As a result of calling getNotesFromOnset() the last element of initialPitches contains the pitch that
               * the mainMelodyPitches needs to start with
               */
              mainMelodyPitches[0] = initialPitches.pop();
              callCounterpointService(mainMelodyPitches, initialPitches, readModeSelection(), readSpeciesSelection());
            });
          }

          // TODO: Factor out common code with getInitialNotesFromAllStaves method
          function getInitialNotesFromNoteset(noteSet, secondPitchInCantus) {
            var initialNotes = [];
            var pitchToReserve = 0;
            for (noteIdx = 0; noteIdx < noteSet.notes.length; noteIdx++) {
              var curChordNote = noteSet.notes[noteIdx];
              console.log("curChordNote.pitch:" + (curChordNote.pitch + 12));
              if (Math.abs(secondPitchInCantus - curChordNote.pitch) <
                      Math.abs(secondPitchInCantus - pitchToReserve)) {
                if (pitchToReserve != 0) {
                  initialNotes.push(pitchToReserve + 12);
                }
                pitchToReserve = curChordNote.pitch;
              }
              else {
                initialNotes.push(curChordNote.pitch + 12);
              }
            }
            if (initialNotes.length == 0) {
              initialNotes.push(pitchToReserve - 12 + 12); //TODO: Handle the 12 tone difference between MIDI and Noteflight note pitches better everywhere
            }

            // Push the note being reserved for the first note in the cantus firmus
            initialNotes.push(pitchToReserve + 12);
            return initialNotes;
          }

          // TODO: Factor out common code with getInitialNotesFromNoteset method
          function getInitialNotesFromAllStaves(staves, secondPitchInCantus) {
            var initialNotes = [];
            var pitchToReserve = 0;
            for (staffIdx = 0; staffIdx < staves.length; staffIdx++) {
              curStaff = staves[staffIdx];
              if (curStaff.measures.length > 0) {
                var curMeasure = curStaff.measures[0];
                if (curMeasure.noteSets.length > 0) {
                  var curNoteSet = curMeasure.noteSets[0];
                  if (curNoteSet.notes.length > 0) {
                    var curNote = curNoteSet.notes[0];
                    if (Math.abs(secondPitchInCantus - curNote.pitch) <
                            Math.abs(secondPitchInCantus - pitchToReserve)) {
                      if (pitchToReserve != 0) {
                        initialNotes.push(pitchToReserve + 12);
                      }
                      pitchToReserve = curNote.pitch;
                    }
                    else {
                      initialNotes.push(curNote.pitch + 12);
                    }
                  }
                }
              }
            }
            if (initialNotes.length == 0) {
              initialNotes.push(pitchToReserve - 12 + 12);
            }

            // Push the note being reserved for the first note in the cantus firmus
            initialNotes.push(pitchToReserve + 12);
            return initialNotes;
          }

          function readModeSelection() {
            var modeVal = $('#modeIds').val();
            var modeValInt = isNaN(modeVal) ? 0 : parseInt(modeVal);
            return modeValInt;
          }

          function readSpeciesSelection() {
            var speciesVal = $('#speciesIds').val();
            var speciesValInt = isNaN(speciesVal) ? 1 : parseInt(speciesVal);
            return speciesValInt;
          }

        </script>

        <script src="js/vendor/jquery.js"></script>
        <script src="js/foundation.min.js"></script>
        <script>
          $(document).foundation();
        </script>
        <script>
            // Throttled resize function
            $(window).on('resize', Foundation.utils.throttle(function(e){
                $( "#score1" ).attr("width",window.innerWidth - widthMargin).attr("height",window.innerHeight - heightMargin);
            }, 300));

        </script>
      </div>
    </div>

  </body>
</html>
