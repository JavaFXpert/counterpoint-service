<!doctype html>
<html class="no-js" lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Foundation | Welcome</title>
    <link rel="stylesheet" href="css/foundation.css" />
    <script src="js/vendor/modernizr.js"></script>
    <script src="js/nfclient.js"></script>
  </head>

  <body>
    <div id="score1"></div>
    <script>
      // Initialize the Noteflight client API.
      NFClient.init(function(info) {
        //alert("Noteflight API is ready, version " + info.version);
      });

      var options = {
        host: 'hacking.sites.noteflight.com',
        width: 900,
        height: 700,
        viewParams: {
          scale: 1.5,
          role: 'template',
          app: 'html5',
          displayMode: 'flow'
        }
      };

      var scoreView = new NFClient.ScoreView('score1', '3b88798c7533d46aa60c3c8077e44742c7c4027a', options);

      function callCounterpointService(mainMelody) {
        var cantusFirmusJson = {
          "mainMelody" : mainMelody,
          "partsInitialNotes" : [48, 55],
          "counterpointSpecies" : 4,
          "scaleMode" : 6
        };
        cantusFirmusJson = JSON.stringify(cantusFirmusJson);
        $.ajax({
          method: 'POST',
          contentType: 'application/json',
          url: 'http://localhost:8080/counterpoint',
          data: cantusFirmusJson
        }).done(function (doc) {
          scoreView.loadMusicXML(doc.documentElement.outerHTML);
        });
      }

      function readMainMelody() {
        var mainMelodyPitches = [];
        scoreView.getScore().done(function(scoreData) {
          if (scoreData != null && scoreData.staves.length > 0) {
            var curStaff = scoreData.staves[0];
            for (var measIdx = 0; measIdx < curStaff.measures.length; measIdx++) {
              var curMeasure = curStaff.measures[measIdx];
              for (var noteSetIdx = 0; noteSetIdx < curMeasure.noteSets.length; noteSetIdx++) {
                var curNoteSet = curMeasure.noteSets[noteSetIdx];
                if (curNoteSet.notes.length > 0) {
                  var curNote = curNoteSet.notes[0];
                  console.log("curNote.pitch:" + (curNote.pitch + 12));
                  mainMelodyPitches.push(curNote.pitch + 12);
                }
              }
            }
            //
          }
          callCounterpointService(mainMelodyPitches);
        });
      }

    </script>

    <div class="row">
      <div class="large-8 columns">
        <h1>Composing Music in the Cloud</h1>

        <div class="small-4 columns">
          <button class="small button" onclick="readMainMelody()">readMainMelody</button>
        </div>
        <!--div class="small-6 columns">
          <button class="small button" onclick="callCounterpointService()">callCounterpointService</button>
        </div-->

      </div>
    </div>
    <script src="js/vendor/jquery.js"></script>
    <script src="js/foundation.min.js"></script>
    <script>
      $(document).foundation();
    </script>
  </body>
</html>
